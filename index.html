<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F.A.S.T: Davranış Karşılaştırma — Benim Davranışlarım / Onun Davranışları</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#e8e8e8;
      --soft:#f7f7f7;
      --focus:#0b5fff;
      --radius:14px;
      --color-me: #2563eb;      /* Mavi - Ben */
      --color-other: #dc2626;   /* Kırmızı - O */
      --selected-text: #111;    /* Seçili metin rengi */
      --unselected-text: #999;  /* Seçilmemiş metin rengi */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.35;
      padding:18px 14px 40px;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:4px;
    }
    h1{
      margin:0;
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.2px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
    }

    /* AKORDEON BAŞLIK STİLİ */
    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    .accordion-header:hover {
      background-color: var(--soft);
    }
    .accordion-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
      font-size: 14px;
      font-weight: 800;
    }
    .accordion-icon {
      font-size: 12px;
      transition: transform 0.3s ease;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
    }
    .accordion-content {
      padding: 0 14px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, padding 0.4s ease;
    }
    .accordion-open .accordion-content {
      padding-bottom: 14px;
      max-height: 2000px;
    }
    .accordion-open .accordion-icon {
      transform: rotate(90deg);
    }

    .section-title{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:800;
    }

    /* --- TABLE --- */
    .table-scroll{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:12px;
      border:1px solid var(--border);
      margin-top: 10px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:720px;
      background:#fff;
    }

    thead th{
      position:sticky;
      top:0;
      background:var(--soft);
      z-index:3;
      font-weight:800;
      font-size:12px;
      color:#222;
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      text-align:center;
      white-space:nowrap;
    }

    /* SOL SÜTUN SABİT */
    thead th:first-child,
    tbody td:first-child{
      position:sticky;
      left:0;
      z-index:4;
      background:#fff;
      box-shadow:1px 0 0 var(--border);
    }
    thead th:first-child{
      background:var(--soft);
      z-index:6;
      text-align:left;
      padding-left:12px;
    }

    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      text-align:center;
      vertical-align:middle;
    }
    tbody tr:last-child td{border-bottom:none;}
    tbody td:first-child{
      text-align:left;
      font-weight:700;
      padding-left:12px;
      white-space:nowrap;
    }

    /* SEÇİLİ DAVRANIŞ STİLİ */
    .behavior-selected {
      font-weight: 900 !important;
      color: var(--selected-text) !important;
    }
    .behavior-unselected {
      font-weight: 400 !important;
      color: var(--unselected-text) !important;
    }

    /* UÇ TANIM SATIRI */
    .hint-row td{
      padding:6px 10px;
      border-bottom:none;
      background:#fff;
      font-size:11px;
      color:var(--muted);
    }
    .hint-row td:first-child{
      color:transparent;
      user-select:none;
    }
    .hint-row td.label{
      font-weight:800;
      color:var(--muted);
      white-space:nowrap;
    }

    .rwrap{
      display:flex;
      align-items:center;
      justify-content:center;
      min-width:38px;
      min-height:34px;
    }
    input[type="radio"]{
      width:18px;
      height:18px;
      accent-color:var(--focus);
      cursor:pointer;
    }

    .status{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      color:#222;
      background:#fff;
    }
    .pill b{font-weight:900}

    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:#111;
      border-radius:999px;
      padding:9px 12px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
    }
    .btn:focus{outline:3px solid rgba(11,95,255,.2); outline-offset:2px;}
    .btn:hover{background:#fafafa}

    .hint{
      color:var(--muted);
      font-size:12px;
      margin:10px 0 0 0;
    }

    .hidden{display:none !important;}

    /* chart - OPTİMİZE EDİLDİ */
    .chart-box{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .chart-stack{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      .chart-stack{grid-template-columns:1fr 1fr;}
    }
    @media (min-width: 1100px){
      .chart-stack{grid-template-columns:1fr 1fr 1fr;}
    }
    .chart-title{
      margin:0 0 8px 0;
      font-size:12px;
      font-weight:900;
      color:#222;
    }
    .chart-panel{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
      /* Sabit min-height kaldırıldı, içerik boyutuna göre ayarlandı */
      display: flex;
      flex-direction: column;
    }
    .chart-container {
      flex: 1;
      min-height: 0; /* Flex container içinde boyut kontrolü */
      position: relative;
    }
    canvas{
      max-width:100% !important;
      width:100% !important;
      height: 240px !important; /* Sabit yükseklik */
    }

    /* Renk göstergesi */
    .chart-legend {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 10px;
      font-size: 11px;
      font-weight: 700;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .legend-color.me {
      background-color: var(--color-me);
    }
    .legend-color.other {
      background-color: var(--color-other);
    }

    /* KARŞILAŞTIRMA TABLOSU */
    .compare-table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .compare-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
      background: #fff;
    }
    
    .compare-table thead th {
      background: var(--soft);
      font-weight: 800;
      font-size: 12px;
      color: #222;
      border-bottom: 2px solid var(--border);
      padding: 12px 10px;
      text-align: center;
      white-space: nowrap;
    }
    
    .compare-table tbody td {
      border-bottom: 1px solid var(--border);
      padding: 12px 10px;
      text-align: center;
      vertical-align: middle;
      font-size: 13px;
    }
    
    .compare-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .compare-table .behavior-name {
      text-align: left;
      font-weight: 700;
      padding-left: 12px;
      white-space: nowrap;
    }
    
    .compare-table .score {
      font-weight: 900;
      font-size: 14px;
    }
    
    .compare-table .diff {
      font-weight: 900;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      display: inline-block;
      min-width: 50px;
    }
    
    .diff-positive {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .diff-negative {
      background: #ffebee;
      color: #c62828;
    }
    
    .diff-zero {
      background: #f5f5f5;
      color: #666;
    }

    footer{
      margin-top:2px;
      color:var(--muted);
      font-size:11px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <h1 style="text-align:center;">F.A.S.T. Davranış Karşılaştırma</h1>
      <p class="sub">Önce <b>Benim Davranışlarım</b>, sonra aynı kriterlerle <b>Onun Davranışları</b> değerlendirmesi yap. Her iki seçim tamamlanınca üç radar grafik görünür.</p>
    </header>

    <!-- BENİM DAVRANIŞLARIM - AKORDEON -->
    <section class="card accordion" id="accordion-me">
      <div class="accordion-header" id="header-me" aria-expanded="false" aria-controls="content-me">
        <h2 class="accordion-title">
          <span class="accordion-icon">▶</span>
          Benim Davranışlarım
        </h2>
      </div>
      <div class="accordion-content" id="content-me">
        <div class="table-scroll" role="region" aria-label="Benim davranışlarım tablosu (yatay kaydırılabilir)">
          <table id="tableMe">
            <thead>
              <tr>
                <th>Davranış</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="status">
          <span class="pill">Tamamlanan: <b id="doneMe">0</b>/<b id="totalMe">0</b></span>
          <button class="btn" id="resetMe" type="button">Temizle</button>
        </div>

        <p class="hint">Not: Bu bölüm tamamlanınca "Benim Konfor Alanı Grafiğim" otomatik oluşur.</p>
      </div>
    </section>

    <!-- ONUN DAVRANIŞLARI - AKORDEON -->
    <section class="card accordion" id="accordion-other">
      <div class="accordion-header" id="header-other" aria-expanded="false" aria-controls="content-other">
        <h2 class="accordion-title">
          <span class="accordion-icon">▶</span>
          Onun Davranışları
        </h2>
      </div>
      <div class="accordion-content" id="content-other">
        <div class="table-scroll" role="region" aria-label="Onun davranışları tablosu (yatay kaydırılabilir)">
          <table id="tableOther">
            <thead>
              <tr>
                <th>Davranış</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="status">
          <span class="pill">Tamamlanan: <b id="doneOther">0</b>/<b id="totalOther">0</b></span>
          <button class="btn" id="resetOther" type="button">Temizle</button>
        </div>

        <p class="hint">Not: Bu bölüm tamamlanınca "Onun Konfor Alanı Grafiği" otomatik oluşur.</p>
      </div>
    </section>

    <!-- GRAFİKLER - 3 GRAFİKLİ -->
    <section class="card" aria-labelledby="sec-charts">
      <h2 class="section-title" id="sec-charts">Grafikler</h2>

      <div class="chart-box">
        <div class="chart-stack">
          <!-- BENİM GRAFİĞİ -->
          <div class="chart-panel">
            <p class="chart-title">Benim Konfor Alanım</p>
            <p class="hint" id="hintChartMe">Grafiği görmek için "Benim Davranışlarım" bölümündeki tüm seçimleri tamamla.</p>
            <div id="wrapChartMe" class="hidden">
              <div class="chart-container">
                <canvas id="chartMe" aria-label="Benim radar grafik" role="img"></canvas>
              </div>
              <div class="chart-legend">
                <div class="legend-item">
                  <div class="legend-color me"></div>
                  <span>Ben</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ONUN GRAFİĞİ -->
          <div class="chart-panel">
            <p class="chart-title">Onun Konfor Alanı</p>
            <p class="hint" id="hintChartOther">Grafiği görmek için "Onun Davranışları" bölümündeki tüm seçimleri tamamla.</p>
            <div id="wrapChartOther" class="hidden">
              <div class="chart-container">
                <canvas id="chartOther" aria-label="Onun radar grafik" role="img"></canvas>
              </div>
              <div class="chart-legend">
                <div class="legend-item">
                  <div class="legend-color other"></div>
                  <span>O</span>
                </div>
              </div>
            </div>
          </div>

          <!-- KARŞILAŞTIRMA GRAFİĞİ -->
          <div class="chart-panel">
            <p class="chart-title">Karşılaştırmalı Görünüm</p>
            <p class="hint" id="hintChartCompare">Grafiği görmek için her iki bölümdeki tüm seçimleri tamamla.</p>
            <div id="wrapChartCompare" class="hidden">
              <div class="chart-container">
                <canvas id="chartCompare" aria-label="Karşılaştırmalı radar grafik" role="img"></canvas>
              </div>
              <div class="chart-legend">
                <div class="legend-item">
                  <div class="legend-color me"></div>
                  <span>Ben</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color other"></div>
                  <span>O</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- KARŞILAŞTIRMA TABLOSU -->
    <section class="card" aria-labelledby="sec-compare">
      <h2 class="section-title" id="sec-compare">Davranış Karşılaştırma Tablosu</h2>
      <p class="hint" id="hintCompare">Her iki değerlendirme de tamamlanınca, tüm davranışların karşılaştırması bu tabloda görüntülenir.</p>

      <div id="wrapCompare" class="hidden">
        <div class="compare-table-scroll">
          <table class="compare-table">
            <thead>
              <tr>
                <th class="behavior-name">Davranış</th>
                <th>Benim Şiddetim</th>
                <th>Onun Şiddeti</th>
                <th>Fark (Ben - O)</th>
              </tr>
            </thead>
            <tbody id="compareTableBody"></tbody>
          </table>
        </div>
        <p class="hint" style="margin-top:12px;">Pozitif fark (+): Benim davranışım daha yüksek | Negatif fark (–): Onun davranışı daha yüksek</p>
      </div>
    </section>

    <footer>Arka plan: beyaz • Mobil: tablo yatay kaydırılabilir • Sol sütun sabit • 2 akordeon + 3 radar grafik + karşılaştırma tablosu</footer>
  </div>

  <script>
    // Davranışlar alfabetik (Türkçe) sırada
    const behaviors = [
      "Duruş",
      "Ellerin Kullanımı",
      "Göz Teması",
      "İçerik",
      "Kelime Sayısı",
      "Konuşma Hızı",
      "Mimikler",
      "Sesin Hacmi"
    ];

    // Uç tanımları (1 ve 9)
    const endpoints = {
      "Konuşma Hızı":       { low: "Yavaş",      high: "Hızlı" },
      "Sesin Hacmi":        { low: "Zayıf",      high: "Güçlü" },
      "Mimikler":           { low: "Kontrollü",  high: "Hareketli" },
      "Göz Teması":         { low: "Dolaylı",    high: "Doğrudan" },
      "Ellerin Kullanımı":  { low: "Az",         high: "Çok" },
      "Duruş":              { low: "Çekingen",   high: "Atak" },
      "İçerik":             { low: "Hikayeler",  high: "Gerçekler" },
      "Kelime Sayısı":      { low: "Az",         high: "Çok" }
    };

    // --- DOM ---
    const tableMeBody = document.querySelector("#tableMe tbody");
    const tableOtherBody = document.querySelector("#tableOther tbody");

    const doneMeEl = document.getElementById("doneMe");
    const doneOtherEl = document.getElementById("doneOther");
    const totalMeEl = document.getElementById("totalMe");
    const totalOtherEl = document.getElementById("totalOther");

    const resetMeBtn = document.getElementById("resetMe");
    const resetOtherBtn = document.getElementById("resetOther");

    const hintChartMe = document.getElementById("hintChartMe");
    const hintChartOther = document.getElementById("hintChartOther");
    const hintChartCompare = document.getElementById("hintChartCompare");
    const wrapChartMe = document.getElementById("wrapChartMe");
    const wrapChartOther = document.getElementById("wrapChartOther");
    const wrapChartCompare = document.getElementById("wrapChartCompare");

    const hintCompare = document.getElementById("hintCompare");
    const wrapCompare = document.getElementById("wrapCompare");
    const compareTableBody = document.getElementById("compareTableBody");

    // Akordeon elementleri
    const accordionMe = document.getElementById("accordion-me");
    const accordionOther = document.getElementById("accordion-other");
    const headerMe = document.getElementById("header-me");
    const headerOther = document.getElementById("header-other");

    totalMeEl.textContent = behaviors.length;
    totalOtherEl.textContent = behaviors.length;

    // --- GÜNCELLENMİŞ Akordeon Fonksiyonları ---
    function toggleAccordion(clickedAccordion, clickedHeader) {
      const allAccordions = [accordionMe, accordionOther];
      const allHeaders = [headerMe, headerOther];
      
      // Tıklanan akordeonun durumunu kontrol et
      const isCurrentlyOpen = clickedAccordion.classList.contains("accordion-open");
      
      // Tüm akordeonları kapat
      allAccordions.forEach(accordion => {
        accordion.classList.remove("accordion-open");
      });
      
      // Tüm header'ları kapalı duruma getir
      allHeaders.forEach(header => {
        header.setAttribute("aria-expanded", "false");
      });
      
      // Eğer tıklanan akordeon zaten açık değilse, onu aç
      if (!isCurrentlyOpen) {
        clickedAccordion.classList.add("accordion-open");
        clickedHeader.setAttribute("aria-expanded", "true");
      }
    }

    // Akordeon event listener'ları
    headerMe.addEventListener("click", () => toggleAccordion(accordionMe, headerMe));
    headerOther.addEventListener("click", () => toggleAccordion(accordionOther, headerOther));

    // --- YENİ: Davranış Stil Güncelleme Fonksiyonu ---
    function updateBehaviorStyles(prefix) {
      behaviors.forEach((_, idx) => {
        const behaviorCell = document.querySelector(`#table${prefix === 'me' ? 'Me' : 'Other'} tbody tr:nth-child(${(idx * 2) + 2}) td:first-child`);
        const isSelected = document.querySelector(`input[name="${prefix}_${idx}"]:checked`) !== null;
        
        if (behaviorCell) {
          if (isSelected) {
            behaviorCell.classList.add('behavior-selected');
            behaviorCell.classList.remove('behavior-unselected');
          } else {
            behaviorCell.classList.add('behavior-unselected');
            behaviorCell.classList.remove('behavior-selected');
          }
        }
      });
    }

    // --- Build tables ---
    function buildTable(tbody, prefix){
      tbody.innerHTML = "";

      behaviors.forEach((name, idx) => {
        // hint row
        const hintTr = document.createElement("tr");
        hintTr.className = "hint-row";

        const hintFirst = document.createElement("td");
        hintFirst.textContent = name;
        hintTr.appendChild(hintFirst);

        for(let v=1; v<=9; v++){
          const td = document.createElement("td");
          if(v === 1){
            td.className = "label";
            td.textContent = endpoints[name]?.low ?? "";
          } else if(v === 9){
            td.className = "label";
            td.textContent = endpoints[name]?.high ?? "";
          }
          hintTr.appendChild(td);
        }

        // main row
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = name;
        tdName.classList.add('behavior-unselected'); // Başlangıçta seçilmemiş
        tr.appendChild(tdName);

        for(let v=1; v<=9; v++){
          const td = document.createElement("td");
          const wrap = document.createElement("div");
          wrap.className = "rwrap";

          const input = document.createElement("input");
          input.type = "radio";
          input.name = `${prefix}_${idx}`; // her blok kendi radio grubunda
          input.value = String(v);
          input.setAttribute("aria-label", `${prefix === 'me' ? 'Benim' : 'Onun'} — ${name} şiddet ${v}`);
          input.addEventListener("change", () => {
            onAnyChange();
            updateBehaviorStyles(prefix);
          });

          wrap.appendChild(input);
          td.appendChild(wrap);
          tr.appendChild(td);
        }

        tbody.appendChild(hintTr);
        tbody.appendChild(tr);
      });
    }

    function getSelections(prefix){
      return behaviors.map((_, idx) => {
        const checked = document.querySelector(`input[name="${prefix}_${idx}"]:checked`);
        return checked ? Number(checked.value) : null;
      });
    }

    function updateProgress(prefix, outEl){
      const selections = getSelections(prefix);
      const done = selections.filter(v => v !== null).length;
      outEl.textContent = done;
      
      // Davranış stillerini güncelle
      updateBehaviorStyles(prefix);
      
      return { selections, allDone: done === behaviors.length };
    }

    // --- Charts ---
    let chartMeInstance = null;
    let chartOtherInstance = null;
    let chartCompareInstance = null;

    function renderChart(canvasId, instanceRef, data, isCompare = false){
      const ctx = document.getElementById(canvasId);

      if(instanceRef.current && !isCompare){
        instanceRef.current.data.labels = behaviors;
        instanceRef.current.data.datasets[0].data = data;
        instanceRef.current.update();
        return;
      }

      if(isCompare && instanceRef.current){
        // Karşılaştırma grafiği için iki dataset güncelle
        instanceRef.current.data.labels = behaviors;
        instanceRef.current.data.datasets[0].data = data.meData;
        instanceRef.current.data.datasets[1].data = data.otherData;
        instanceRef.current.update();
        return;
      }

      if(isCompare){
        // Karşılaştırma grafiği oluştur (iki dataset)
        instanceRef.current = new Chart(ctx, {
          type: "radar",
          data: {
            labels: behaviors,
            datasets: [
              {
                label: "Ben",
                data: data.meData,
                fill: true,
                backgroundColor: "rgba(37, 99, 235, 0.2)",
                borderColor: "rgb(37, 99, 235)",
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: "rgb(37, 99, 235)"
              },
              {
                label: "O",
                data: data.otherData,
                fill: true,
                backgroundColor: "rgba(220, 38, 38, 0.2)",
                borderColor: "rgb(220, 38, 38)",
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: "rgb(220, 38, 38)"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                min: 1,
                max: 9,
                ticks: { stepSize: 1 }
              }
            },
            plugins: {
              legend: { 
                display: false // Legend'ı CSS ile kendimiz yapıyoruz
              },
              tooltip: {
                callbacks: { 
                  label: (ctx) => `${ctx.dataset.label} - ${ctx.label}: ${ctx.parsed.r}`
                }
              }
            }
          }
        });
      } else {
        // Normal tek grafik
        instanceRef.current = new Chart(ctx, {
          type: "radar",
          data: {
            labels: behaviors,
            datasets: [{
              label: "Şiddet (1–9)",
              data,
              fill: true,
              borderWidth: 2,
              pointRadius: 3,
              backgroundColor: canvasId === "chartMe" ? "rgba(37, 99, 235, 0.2)" : "rgba(220, 38, 38, 0.2)",
              borderColor: canvasId === "chartMe" ? "rgb(37, 99, 235)" : "rgb(220, 38, 38)",
              pointBackgroundColor: canvasId === "chartMe" ? "rgb(37, 99, 235)" : "rgb(220, 38, 38)"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                min: 1,
                max: 9,
                ticks: { stepSize: 1 }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed.r}` }
              }
            }
          }
        });
      }
    }

    // --- Karşılaştırma Tablosu Oluşturma ---
    function renderCompareTable(meData, otherData){
      compareTableBody.innerHTML = "";

      behaviors.forEach((name, i) => {
        const meVal = meData[i];
        const otherVal = otherData[i];
        const diff = meVal - otherVal;
        
        const tr = document.createElement("tr");
        
        // Davranış adı
        const tdName = document.createElement("td");
        tdName.className = "behavior-name";
        tdName.textContent = name;
        
        // Benim şiddetim
        const tdMe = document.createElement("td");
        tdMe.className = "score";
        tdMe.textContent = meVal;
        
        // Onun şiddeti
        const tdOther = document.createElement("td");
        tdOther.className = "score";
        tdOther.textContent = otherVal;
        
        // Fark
        const tdDiff = document.createElement("td");
        const diffSpan = document.createElement("span");
        diffSpan.className = "diff";
        
        if (diff > 0) {
          diffSpan.classList.add("diff-positive");
          diffSpan.textContent = `+${diff}`;
        } else if (diff < 0) {
          diffSpan.classList.add("diff-negative");
          diffSpan.textContent = `${diff}`; // zaten eksi işaretli
        } else {
          diffSpan.classList.add("diff-zero");
          diffSpan.textContent = "0";
        }
        
        tdDiff.appendChild(diffSpan);
        
        tr.appendChild(tdName);
        tr.appendChild(tdMe);
        tr.appendChild(tdOther);
        tr.appendChild(tdDiff);
        
        compareTableBody.appendChild(tr);
      });
    }

    // --- Main update ---
    function onAnyChange(){
      const me = updateProgress("me", doneMeEl);
      const other = updateProgress("other", doneOtherEl);

      // Benim grafik
      if(me.allDone){
        hintChartMe.classList.add("hidden");
        wrapChartMe.classList.remove("hidden");
        const meData = me.selections.map(Number);
        renderChart("chartMe", { current: chartMeInstance }, meData);
        chartMeInstance = Chart.getChart("chartMe") || chartMeInstance;
      } else {
        hintChartMe.classList.remove("hidden");
        wrapChartMe.classList.add("hidden");
      }

      // Onun grafik
      if(other.allDone){
        hintChartOther.classList.add("hidden");
        wrapChartOther.classList.remove("hidden");
        const otherData = other.selections.map(Number);
        renderChart("chartOther", { current: chartOtherInstance }, otherData);
        chartOtherInstance = Chart.getChart("chartOther") || chartOtherInstance;
      } else {
        hintChartOther.classList.remove("hidden");
        wrapChartOther.classList.add("hidden");
      }

      // Karşılaştırma Grafiği
      if(me.allDone && other.allDone){
        hintChartCompare.classList.add("hidden");
        wrapChartCompare.classList.remove("hidden");
        
        const meData = me.selections.map(Number);
        const otherData = other.selections.map(Number);
        renderChart("chartCompare", { current: chartCompareInstance }, { meData, otherData }, true);
        chartCompareInstance = Chart.getChart("chartCompare") || chartCompareInstance;

        // Karşılaştırma Tablosu
        hintCompare.classList.add("hidden");
        wrapCompare.classList.remove("hidden");
        renderCompareTable(meData, otherData);
      } else {
        hintChartCompare.classList.remove("hidden");
        wrapChartCompare.classList.add("hidden");
        hintCompare.classList.remove("hidden");
        wrapCompare.classList.add("hidden");
      }
    }

    resetMeBtn.addEventListener("click", () => {
      document.querySelectorAll('input[type="radio"][name^="me_"]').forEach(r => r.checked = false);
      updateBehaviorStyles('me');
      onAnyChange();
    });

    resetOtherBtn.addEventListener("click", () => {
      document.querySelectorAll('input[type="radio"][name^="other_"]').forEach(r => r.checked = false);
      updateBehaviorStyles('other');
      onAnyChange();
    });

    // init
    buildTable(tableMeBody, "me");
    buildTable(tableOtherBody, "other");
    onAnyChange();
  </script>
</body>
</html>
